# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a Helm charts repository containing Kubernetes deployment charts. Currently includes:
- `pelican-panel`: Helm chart for deploying Pelican Panel (game server management panel)

## Common Commands

### Helm Chart Development
```bash
# Update chart dependencies
helm dependency update charts/pelican-panel

# Lint the chart for errors
helm lint charts/pelican-panel

# Render templates locally for debugging
helm template charts/pelican-panel

# Package the chart
helm package charts/pelican-panel

# Install the chart for testing
helm install test-release charts/pelican-panel -n test-namespace --create-namespace

# Upgrade an existing release
helm upgrade test-release charts/pelican-panel -n test-namespace

# Generate/update chart documentation (requires helm-docs)
helm-docs
```

### Development Workflow
```bash
# Install development dependencies
uv sync

# Run pre-commit hooks on all files
pre-commit run --all-files

# Run pre-commit on staged files (automatically runs on commit)
pre-commit run
```

## Architecture & Structure

### Chart Structure
- `/charts/pelican-panel/` - Main Helm chart
  - `Chart.yaml` - Chart metadata and dependencies
  - `values.yaml` - Default configuration values
  - `/templates/` - Kubernetes resource templates
    - `/cnpg/` - CloudNativePG (PostgreSQL) templates
    - Standard K8s resources: deployment, service, ingress, configmap, secrets
  - `/charts/` - Downloaded dependencies (CloudNativePG)

### Key Design Patterns

1. **Database Integration**
   - Uses CloudNativePG operator for managed PostgreSQL
   - Supports external database connections
   - Database credentials managed via secrets

2. **Template Helpers**
   - `_helpers.tpl` contains reusable template functions
   - Common labels and selectors defined as named templates
   - Environment variable configuration centralized

3. **Security**
   - Non-root container execution (UID/GID 1000)
   - Security contexts with dropped capabilities
   - No privilege escalation allowed

4. **Persistence**
   - Separate PVCs for data and logs
   - Configurable storage classes and sizes
   - Optional ephemeral storage

### CI/CD Pipeline

- **GitHub Actions**:
  - `release-charts.yml` - Packages and publishes charts to GHCR on push to main
  - `pre-commit.yml` - Runs quality checks on PRs

- **Pre-commit Hooks**:
  - YAML validation
  - Trailing whitespace removal
  - helm-docs generation
  - helmlint validation
  - Security checks (private key detection)

## Testing Changes

1. Always lint charts after modifications:
   ```bash
   helm lint charts/pelican-panel
   ```

2. Test template rendering with different values:
   ```bash
   helm template charts/pelican-panel -f custom-values.yaml
   ```

3. Ensure documentation is updated:
   ```bash
   helm-docs
   ```

4. Run pre-commit before committing:
   ```bash
   pre-commit run --all-files
   ```

## Important Notes

- The README.md in each chart directory is auto-generated by helm-docs - do not edit manually
- Chart version should be bumped in Chart.yaml when making changes
- CloudNativePG dependency requires the CNPG operator to be installed in the cluster
- Environment variables in deployment.yaml are generated from values.yaml configuration
